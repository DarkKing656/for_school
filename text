#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#define MAX_LINE_LENGTH 1000

int main(int argc, char *argv[]) {
    int opt;
    char *search_string = NULL;
    FILE *file_ptr = NULL;
    char line[MAX_LINE_LENGTH];

    // Проверка наличия аргументов командной строки
    if (argc < 2) {
        printf("Использование: ./my_grep -s <строка_поиска> [<файл>]\n");
        return 1;
    }

    // Обработка опций командной строки с помощью getopt
    while ((opt = getopt(argc, argv, "s:")) != -1) {
        switch (opt) {
            case 's':
                search_string = optarg;
                break;
            default:
                printf("Неизвестная опция: -%c\n", opt);
                return 1;
        }
    }

    // Опцию -s и соответствующий аргумент должны быть заданы
    if (search_string == NULL) {
        printf("Не задана строка поиска (-s)\n");
        return 1;
    }

    // Если указан файл, открываем его, иначе используем стандартный ввод
    if (optind < argc) {
        file_ptr = fopen(argv[optind], "r");
        if (file_ptr == NULL) {
            printf("Не удалось открыть файл %s\n", argv[optind]);
            return 1;
        }
    } else {
        file_ptr = stdin;
    }

    // Поиск строки в файле
    while (fgets(line, MAX_LINE_LENGTH, file_ptr) != NULL) {
        if (strstr(line, search_string) != NULL) {
            printf("%s", line);
        }
    }

    // Закрываем файл, если он был открыт
    if (file_ptr != stdin) {
        fclose(file_ptr);
    }

    return 0;
}
